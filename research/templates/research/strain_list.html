{% extends "layout/base.html" %}
{% block title %}Strains | HelixMapr{% endblock %}
{% block header_title %}Strains{% endblock %}
{% block content %}
<div class="space-y-6">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <h2 class="text-2xl font-bold">Strain List</h2>
    <div class="flex items-center gap-2">
      <a href="{% url 'csv_upload' %}" class="rounded-md border border-slate-600 bg-slate-900 px-4 py-2 text-sm font-semibold text-primary hover:bg-slate-800">Import CSV</a>
      <a href="{% url 'strain-archived-list' %}" class="rounded-md border border-yellow-500/60 bg-yellow-900/20 px-4 py-2 text-sm font-semibold text-yellow-300 hover:bg-yellow-900/30">Archived Strains</a>
      <a href="{% url 'strain-create' %}" class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-black hover:opacity-90">Create Strain</a>
    </div>
  </div>

  <form method="get" class="grid gap-3 rounded-lg border border-slate-700 bg-slate-800 p-4 md:grid-cols-4">
    <input type="search" name="q" value="{{ search_query }}" placeholder="Search strain ID, name, or custom fields" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
    <select name="status" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
      <option value="">All statuses</option>
      {% for value, label in status_choices %}
        <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="organism" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
      <option value="">All organisms</option>
      {% for organism_value, organism_label in organisms %}
        <option value="{{ organism_value }}" {% if selected_organism == organism_value %}selected{% endif %}>{{ organism_label }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="rounded-md bg-slate-700 px-4 py-2 text-sm font-medium hover:bg-slate-600">Apply Filters</button>

    {% for definition in custom_field_filters %}
      <div class="md:col-span-2">
        <label for="cf_{{ definition.id }}" class="mb-1 block text-xs uppercase tracking-wide text-slate-400">{{ definition.name }}</label>
        {% if definition.field_type == 'choice' %}
          <select id="cf_{{ definition.id }}" name="cf_{{ definition.id }}" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
            <option value="">Any</option>
            {% for option in definition.options %}
              <option value="{{ option }}" {% if definition.selected_value == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        {% elif definition.field_type == 'boolean' %}
          <select id="cf_{{ definition.id }}" name="cf_{{ definition.id }}" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
            <option value="">Any</option>
            <option value="true" {% if definition.selected_value == 'true' %}selected{% endif %}>Yes</option>
            <option value="false" {% if definition.selected_value == 'false' %}selected{% endif %}>No</option>
          </select>
        {% elif definition.field_type == 'date' %}
          <input id="cf_{{ definition.id }}" type="date" name="cf_{{ definition.id }}" value="{{ definition.selected_value }}" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
        {% elif definition.field_type == 'number' %}
          <input id="cf_{{ definition.id }}" type="number" step="any" name="cf_{{ definition.id }}" value="{{ definition.selected_value }}" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
        {% else %}
          <input id="cf_{{ definition.id }}" type="text" name="cf_{{ definition.id }}" value="{{ definition.selected_value }}" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
        {% endif %}
      </div>
    {% endfor %}
  </form>

  {% if can_bulk_edit %}
    <form method="post" action="{% url 'strain-bulk-edit' %}" id="bulk-actions-form" class="rounded-lg border border-slate-700 bg-slate-800 p-4">
      {% csrf_token %}
      <div class="flex flex-wrap items-center gap-3">
        <select name="bulk_action" class="rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm focus:border-primary focus:outline-none">
          <option value="edit">Edit selected</option>
          <option value="delete">Delete selected</option>
          <option value="archive">Archive selected</option>
        </select>
        <button type="submit" class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-black hover:opacity-90">Apply</button>
        <span class="text-sm text-slate-300"><span id="selection-count">0</span> strains selected</span>
      </div>
    </form>
  {% endif %}

  <div class="overflow-hidden rounded-lg border border-slate-700 bg-slate-800">
    <table class="min-w-full divide-y divide-slate-700 text-sm">
      <thead class="bg-slate-900 text-slate-300">
        <tr>
          {% if can_bulk_edit %}
            <th class="px-4 py-3 text-left">
              <input id="select-all" type="checkbox" class="h-4 w-4 rounded border-slate-500 bg-slate-900 text-primary focus:ring-primary">
            </th>
          {% endif %}
          <th class="px-4 py-3 text-left">Strain ID</th>
          <th class="px-4 py-3 text-left">Name</th>
          <th class="px-4 py-3 text-left">Organism</th>
          <th class="px-4 py-3 text-left">Location</th>
          <th class="px-4 py-3 text-left">Status</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-700">
        {% for strain in strains %}
          <tr class="hover:bg-slate-700/30">
            {% if can_bulk_edit %}
              <td class="px-4 py-3">
                <input form="bulk-actions-form" type="checkbox" name="strain_ids" value="{{ strain.id }}" class="strain-checkbox h-4 w-4 rounded border-slate-500 bg-slate-900 text-primary focus:ring-primary">
              </td>
            {% endif %}
            <td class="px-4 py-3"><a class="text-primary hover:underline" href="{% url 'strain-detail' strain.pk %}">{{ strain.strain_id }}</a></td>
            <td class="px-4 py-3">{{ strain.name }}{% if strain.is_archived %} <span class="ml-1 rounded-full bg-yellow-900/40 px-2 py-0.5 text-xs text-yellow-300">Archived</span>{% endif %}</td>
            <td class="px-4 py-3">{{ strain.get_organism_display }}</td>
            <td class="px-4 py-3">{{ strain.location }}</td>
            <td class="px-4 py-3">{{ strain.get_status_display }}</td>
          </tr>
        {% empty %}
          <tr>
            <td class="px-4 py-4 text-slate-400" colspan="6">No active strains found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <div class="flex items-center justify-between">
      <span class="text-sm text-slate-400">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      <div class="flex gap-2">
        {% if page_obj.has_previous %}
          <a href="?q={{ search_query }}&status={{ selected_status }}&organism={{ selected_organism }}&page={{ page_obj.previous_page_number }}" class="rounded-md border border-slate-600 px-3 py-1.5 text-sm hover:bg-slate-700">Previous</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?q={{ search_query }}&status={{ selected_status }}&organism={{ selected_organism }}&page={{ page_obj.next_page_number }}" class="rounded-md border border-slate-600 px-3 py-1.5 text-sm hover:bg-slate-700">Next</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

{% if can_bulk_edit %}
<script>
  const selectAll = document.getElementById('select-all');
  const checkboxes = Array.from(document.querySelectorAll('.strain-checkbox'));
  const selectionCount = document.getElementById('selection-count');

  function refreshSelectionCount() {
    const count = checkboxes.filter((checkbox) => checkbox.checked).length;
    selectionCount.textContent = String(count);
    if (selectAll) {
      selectAll.checked = checkboxes.length > 0 && count === checkboxes.length;
      selectAll.indeterminate = count > 0 && count < checkboxes.length;
    }
  }

  if (selectAll) {
    selectAll.addEventListener('change', () => {
      checkboxes.forEach((checkbox) => {
        checkbox.checked = selectAll.checked;
      });
      refreshSelectionCount();
    });
  }

  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener('change', refreshSelectionCount);
  });
</script>
{% endif %}
{% endblock %}
